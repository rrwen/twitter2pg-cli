#!/usr/bin/env node

// Richard Wen
// rrwen.dev@gmail.com

var fs = require('fs');
var path = require('path');
var twitter2pg = require('twitter2pg');

var defaultPath = path.join(__dirname, 'default.json');
var defaultJSON = require(defaultPath);

// (cli) Command line config
var argv = require('yargs')
	.default(defaultJSON)
	.usage('\nCommand line tool for extracting Twitter data to PostgreSQL databases.\n\nUsage: \n\  $0 <command>\n\  $0 [options]')
	.command('defaults', 'View default options')
	.command('reset', 'Reset default options')
	.command('clear', 'Clear default options')
	.command('set <option> <value>', 'Set default options')
	.command('delete <option>', 'Delete default options')
	.command('doc <type>', 'Open documentation in web browser')
	.command('query <sql>', 'Run a PostgreSQL query')
	.command('file <path>', 'Initialize environment file')
	.alias('f', 'file')
	.describe('file', 'Path to environment file for storing API keys and connections')
	.describe('twitter.method', 'get/post/delete/stream')
	.describe('twitter.path', 'API path')
	.describe('twitter.params', 'API request parameters')
	.describe('pg.table', 'Table name')
	.describe('pg.column', 'Column name of pg.table')
	.describe('pg.query', 'Insert query for Twitter data $1')
	.describe('jsonata', 'JSON filter before pg.query')
	.describe('twitter.connection', 'Twitter API keys')
	.describe('twitter.connection.consumer_key', '')
	.describe('twitter.connection.consumer_secret', '')
	.describe('twitter.connection.access_token_key', '')
	.describe('twitter.connection.access_token_secret', '')
	.describe('pg.connection', 'PostgreSQL connection details')
	.describe('pg.connection.host', '')
	.describe('pg.connection.port', '')
	.describe('pg.connection.database', '')
	.describe('pg.connection.user', '')
	.describe('pg.connection.password', '')
	.alias('v', 'verbose')
	.describe('verbose', 'Display extra log messages')
	.boolean('v')
	.alias('h', 'help')
	.help('h')
	.example('$0 doc twitter2pg', 'Open twitter2pg-cli doc')
	.example('$0 doc twitter', 'Open Twitter API doc')
	.example('$0 doc pg', 'Open PostgreSQL doc')
	.example('\n$0 file path/.env', '\nInitialize env file')
	.example('$0 set file path/.env', 'Set default path for env file')
	.example('$0 delete file', 'Delete default env file path')
	.example('$0 defaults', 'View option defaults')
	.example('\n$0 query "CREATE TABLE twitter_data(tweets jsonb);"', '\nCreate a table to store tweets')
	.example('\n$0', '\nExtract twitter data to table')
	.example('$0 > log.csv', 'Extract and log twitter data to table')
	.argv;
var cmd = argv._[0];

// (options_file) Load options file
if (argv.file != undefined) {
	require('dotenv').config({path: argv.file});
}

// (command_docs) Open docs in browser
if (cmd == 'doc') {
	var opn = require('opn');
	if (argv.type.toLowerCase() == 'twitter2pg') {
		opn('https://www.github.com/rrwen/twitter2pg-cli');
	} else if (argv.type.toLowerCase() == 'twitter') {
		opn('https://developer.twitter.com/en/docs');
	} else if (argv.type.toLowerCase() == 'pg') {
		opn('https://www.postgresql.org/docs/current');
	}
}

// (command_query) Run query in PostgreSQL
if (cmd == 'query') {
	const {Client} = require('pg');
	argv.pg = argv.pg || {};
	argv.pg.connection = argv.pg.connection || {};
	const client = new Client(argv.pg.connection);
	client.connect()
		.then(() => {
			return client.query(argv.sql)
				.then(res => {
					console.log(res.rows);
				});
		})
		.then(() => {
			client.end();
			process.exit(0);
		})
		.catch(err => {
			console.log('\nError:\n', err.message);
		});
}

// (command_init) Initialize options file
if (cmd == 'file') {
	var templatePath = path.join(__dirname, 'template.env');
	var read = fs.createReadStream(templatePath);
	var write = fs.createWriteStream(argv.path);
	read.pipe(write);
}

// (command_defaults) View default options
if (cmd == 'defaults') {
	console.log(defaultJSON);
}

// (command_reset) Reset default options
if (cmd == 'reset') {
	defaultJSON = {
		'twitter.method': 'get',
		'twitter.path': 'search/tweets',
		'twitter.params': '{"q": "twitter"}',
		'pg.table': 'twitter_data',
		'pg.column': 'tweets',
		'pg.query': 'INSERT INTO $options.pg.table($options.pg.column) VALUES ($1);',
		'file': ''
	};
	fs.writeFileSync(defaultPath, JSON.stringify(defaultJSON));
	console.log('Reset defaults');
}

// (command_reset) Reset default options
if (cmd == 'clear') {
	defaultJSON = {};
	fs.writeFileSync(defaultPath, JSON.stringify(defaultJSON));
	console.log('Clear defaults');
}

// (command_set) Set default options
if (cmd == 'set') {
	defaultJSON[argv.option] = argv.value;
	fs.writeFileSync(defaultPath, JSON.stringify(defaultJSON));
	console.log('Set default', argv.option, 'to', argv.value);
}

// (command_delete) Delete default options
if (cmd == 'delete') {
	delete defaultJSON[argv.option];
	fs.writeFileSync(defaultPath, JSON.stringify(defaultJSON));
	console.log('Delete default', argv.option);
}

// (command_run) Run twitter2pg
if (argv._.length < 1) {
	
	// (command_run_options) Default run options
	argv.twitter = argv.twitter || {};
	argv.twitter.method = argv.twitter.method || process.env.TWITTER_METHOD || 'get';
	argv.twitter.path =argv.twitter.path || process.env.TWITTER_PATH || 'search/tweets';
	argv.twitter.params = argv.twitter.params || process.env.TWITTER_PARAMS || {q:'twitter'};
	argv.pg.table = argv.pg.table || process.env.PGTABLE || 'twitter2pg_table';
	argv.pg.column = argv.pg.column || process.env.PGCOLUMN || 'tweets';
	argv.pg.query = argv.pg.query || process.env.PGQUERY || 'INSERT INTO $options.pg.table ($options.pg.column) VALUES ($1);';
	
	// (command_run_info) Information JSON
	var quote = '"';
	var delim = ",";
	var info = {
		twitter: {
			method: argv.twitter.method,
			path: argv.twitter.path,
			params: argv.twitter.params
		},
		pg: {
			table: argv.pg.table,
			column: argv.pg.column,
			query: argv.pg.query
		}
	}
	header = 'time_iso8601' + delim + 'status' + delim + 'message' + delim + 'json\n'
	info = quote + new Date().toISOString() + quote + delim + quote + 'start' + quote + delim  + quote + 'Options' + quote + delim + quote + JSON.stringify(info).replace(/"/g, '""') + quote;
	console.log(header + info);
	
	// (command_stream) Twitter stream API
	if (argv.twitter.method == 'stream') {
		
		// (command_stream_verbose) Success log messages for streams
		if (argv.verbose) {
			argv.stream = {};
			argv.stream.callback = function(err, data) {
				console.log(quote + new Date().toISOString() + quote + delim + quote + 'success' + quote + delim + delim);
			};
		}
		
		// (command_stream_run) Start streaming process and log errors
		var stream = twitter2pg(argv);
		stream.on('error', function(err) {
			console.log(quote + new Date().toISOString() + quote + delim + quote + 'error' + quote + delim + quote + err.message + quote + delim + quote + JSON.stringify(err) + quote + delim);
		});
	} else {
		
		// (command_rest) Twitter REST API
		twitter2pg(argv)
			.then(data => {
				if (argv.verbose) {
					console.log(quote + new Date().toISOString() + quote + delim + quote + 'success' + quote + delim + delim);
				}
				data.pg.client.end();
				process.exit(0);
			})
			.catch(err => {
				console.log(quote + new Date().toISOString() + quote + delim + quote + 'error' + quote + delim + quote + err[0].message + quote + delim + quote + JSON.stringify(err).replace(/"/g, '""') + quote + delim);
				process.exit(1);
			});
	}
}
